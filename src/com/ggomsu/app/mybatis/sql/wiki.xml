<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Config 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!-- 작성자 : 박성민 -->
<mapper namespace="Wiki">
	<select id="getAllRvsBySubject" parameterType="string" resultType="wikiInfo">
		SELECT *
		FROM wikiInfo
		WHERE subject = #{subject}
		AND deletedAt IS NULL
		ORDER BY rvs DESC
	</select>
	<select id="getRecentSubject" resultType="wikiInfo">
		SELECT subject, MAX(rvs), revisedAt
		FROM wikiInfo
		WHERE deletedAt IS NULL
		GROUP BY subject
		ORDER BY revisedAt DESC
		LIMIT 10
	</select>
	<select id="getContentOne" parameterType="map" resultType="wikiContent">
		SELECT *
		FROM wikiContents
		WHERE (rvs, subject) = (#{rvs}, #{subject})
		ORDER BY rvs ASC, rvsIndex ASC
	</select>
	<select id="getContentPast" parameterType="map" resultType="wikiContent">
		<![CDATA[
		SELECT *
		FROM wikiContents
		WHERE rvs < ${rvs}
		AND subject = #{subject}
		AND content IS NOT NULL
		ORDER BY rvs ASC, rvsIndex ASC
		]]>
	</select>
	<select id="getWikiInfo" parameterType="map" resultType="wikiInfo">
		SELECT *
		FROM wikiInfo
		WHERE (subject, rvs) = (#{subject}, #{rvs})
		LIMIT 1
	</select>
	<insert id="insertWikiInfo" parameterType="wikiInfo">
		INSERT INTO wikiInfo(subject, rvs, nickname, ip)
		VALUES (#{subject}, #{rvs}, #{nickname}, #{ip})
	</insert>
	<insert id="insertWikiContents" parameterType="wikiContent">
		INSERT INTO wikiContents
		VALUES 
		<foreach item="contents" collection="list" separator=",">
			(#{contents.subject}, #{contents.rvs}, #{contents.rvsIndex}, #{contents.preRvs}, #{contents.preRvsIndex}, #{contents.content})
		</foreach>
	</insert>
	<select id="checkBlockedIp" parameterType="string" resultType="_int">
		SELECT COUNT(ip)
		FROM wikiAbuse
		WHERE ip = #{ip}
	</select>
	<select id="checkBlockedNickname" parameterType="string" resultType="_int">
		SELECT COUNT(nickname)
		FROM wikiAbuse
		WHERE nickname = #{nickname}
	</select>
	<select id="checkExistBySubject" parameterType="string" resultType="_int">
		SELECT COUNT(subject)
		FROM wikiInfo
		WHERE subject = #{subject}
		AND rvs = 1
	</select>
	<select id="getAbuseInfo" parameterType="map" resultType="wikiAbuse">
		SELECT * FROM wikiAbuse
		WHERE 
		<choose>
			<when test='nickname.equals("noname")'>
				ip = #{ip}
			</when>
			<otherwise>
				nickname = #{nickname}
			</otherwise>
		</choose>
	</select>
	<select id="reviseWikiInfo" statementType="CALLABLE" parameterType="wikiInfo" resultType="_int">
		CALL reviseWikiInfo(#{subject}, #{nickname}, #{ip}, #{rvs})
	</select>
</mapper>
