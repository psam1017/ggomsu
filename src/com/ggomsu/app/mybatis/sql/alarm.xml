<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Config 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
	<!-- 작성자 : 김지혜 -->
<mapper namespace="Alarm">

	<select id="checkArticleAlarm" parameterType="_int" resultType="_int">
		SELECT COUNT(*) FROM articlealarm
		WHERE articleIndex = #{articleIndex}
	</select>
	
	<select id="checkCommentAlarm" parameterType="_int" resultType="_int">
		SELECT COUNT(*) FROM commentalarm
		WHERE refIndex = #{refIndex}
	</select>
	
	<insert id ="insertCommentAlarm" parameterType="articleAlarm">
		INSERT INTO articleAlarm(nickname, articleIndex, commentIndex)
		VALUES(#{nickname}, #{articleIndex}, #{commentIndex})
	</insert>
	
	<insert id ="insertRefCommentAlarm" parameterType="commentAlarm">
		INSERT INTO commentAlarm(nickname, commentIndex, refIndex)
		VALUES(#{nickname}, #{commentIndex}, #{refIndex})
	</insert>
	
	<select id="getCommentAlarmCount" parameterType="String" resultType="_int">
		<![CDATA[
		SELECT (SELECT COUNT(*)FROM articlealarm aa WHERE aa.articleindex IN
		(SELECT a.articleIndex FROM articles a where nickname=#{nickname}))+
		(SELECT COUNT(*)FROM commentalarm ca WHERE ca.refIndex IN
		(SELECT c.commentIndex FROM comments c where nickname=#{nickname}))AS sum
		]]>
	</select>
	
	<select id ="getCommentAlarmList" parameterType="String" resultType="comment">
		<![CDATA[
		SELECT distinct aa.articleIndex, c.commentIndex, c.refIndex, c.nickname, c.content, c.writtenAt
		FROM articlealarm aa, comments c
		WHERE c.nickname != #{nickname}
		AND c.articleIndex = aa.articleIndex
		AND c.commentIndex = aa.commentIndex
		AND aa.nickname = #{nickname}
		]]>
	</select>
	
	<select id ="getRefCommentAlarmList" parameterType="String" resultType="comment">
		<![CDATA[
		SELECT distinct c.articleIndex, c.commentIndex, ca.refIndex, c.nickname, c.content, c.writtenAt
		FROM commentalarm ca, comments c
		WHERE c.nickname != #{nickname}
		AND c.refIndex = ca.refIndex
		AND c.commentIndex = ca.commentIndex
		AND ca.nickname = #{nickname}
		]]>
	</select>
	
	<select id="getCommentContent" parameterType="String" resultType="comment">
		SELECT DISTINCT c.commentIndex, c.content
		FROM commentalarm ca, comments c
		where ca.refIndex = c.commentIndex
		AND ca.nickname = #{nickname}
	</select>
	
	<select id="getArticleTitle" parameterType="String" resultType="article">
		SELECT DISTINCT a.articleIndex, a.title
		FROM articlealarm aa, comments c, articles a
		WHERE c.nickname != #{nickname}
		AND a.articleIndex = aa.articleIndex
		AND aa.commentIndex = c.commentIndex;
	</select>
	
	<delete id="deleteCommentAlarm" parameterType="_int">
		DELETE FROM articlealarm where commentIndex = #{commentIndex}
	</delete>
	
	<delete id="deleteRefCommentAlarm" parameterType="_int">
		DELETE FROM commentalarm where commentIndex = #{commentIndex}
	</delete>
	
</mapper>